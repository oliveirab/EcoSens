---
title: "Sensitivity of primary productivity to climate is mediated by biodiversity"
author: "Brunno F Oliveira"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide 
---
  
  *** 
  
  \newpage

```{r packages, message=FALSE, include=FALSE}
rm(list=ls())
gc()
 
# library(devtools)
# install_github("jslefche/piecewiseSEM@devel", build_vignette = TRUE)
 
# install.packages("BiocManager")
# BiocManager::install("Rgraphviz")
 
# Must use DiagrammeR v0.6
# require(devtools)
# install_version("DiagrammeR", version = "0.6", repos = "http://cran.us.r-project.org")

list.of.packages <- c("raster","maps","nlme","spdep","rgdal","viridis","ggplot2","rworldmap","gridExtra","cowplot","effects","PerformanceAnalytics","classInt","reshape2","scales", "dplyr","foreach","doParallel","pbapply","maptools")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

sapply(list.of.packages, require, character.only = TRUE)


```

# Packages versions:
```{r info, message=FALSE, include=FALSE}
info <- sessionInfo()
```

We used `r info$R.version$version.string` and the following packages:   

```{r packs, message=FALSE}
data.frame(Package = unlist(lapply(info$otherPkgs, function(x) x$Package)), 
           version = unlist(lapply(info$otherPkgs, function(x) x$Version)),
           row.names = NULL)
```

# Load functions
```{r load.fun, message=FALSE, warning=FALSE}

myramp <- hcl.colors(10)

#### Bivariate maps
#function to generate bivariate maps. Copy and paste that into R:
bivariate.map<-function(rasterx, rastery, colormatrix=col.matrix, nquantiles=10){
  quanmean<-getValues(rasterx)
  temp <- data.frame(quanmean, quantile=rep(NA, length(quanmean)))
  brks <- with(temp, quantile(temp,na.rm=TRUE, probs = c(seq(0,1,1/nquantiles))))
  r1 <- within(temp, quantile <- cut(quanmean, breaks = brks, labels = 2:length(brks),include.lowest = TRUE))
  quantr<-data.frame(r1[,2]) 
  quanvar<-getValues(rastery)
  temp <- data.frame(quanvar, quantile=rep(NA, length(quanvar)))
  brks <- with(temp, quantile(temp,na.rm=TRUE, probs = c(seq(0,1,1/nquantiles))))
  r2 <- within(temp, quantile <- cut(quanvar, breaks = brks, labels = 2:length(brks),include.lowest = TRUE))
  quantr2<-data.frame(r2[,2])
  as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}
  col.matrix2<-colormatrix
  cn<-unique(colormatrix)
  for(i in 1:length(col.matrix2)){
    ifelse(is.na(col.matrix2[i]),col.matrix2[i]<-1,col.matrix2[i]<-which(col.matrix2[i]==cn)[1])}
  cols<-numeric(length(quantr[,1]))
  for(i in 1:length(quantr[,1])){
    a<-as.numeric.factor(quantr[i,1])
    b<-as.numeric.factor(quantr2[i,1])
    cols[i]<-as.numeric(col.matrix2[b,a])}
  r<-rasterx
  r[1:length(r)]<-cols
  return(r)}

colmat<-function(nquantiles=10, 
                 upperleft=rgb(0,150,235, maxColorValue=255), 
                 upperright=rgb(130,0,80, maxColorValue=255), 
                 bottomleft="grey", bottomright=rgb(255,230,15, maxColorValue=255), 
                 xlab="x label", ylab="y label",add=F,
                 cex=0.5,cex.lab=1.3,cex.axis=1,
                 .plot=T){
  my.data<-seq(0,1,.01)
  my.class<-classIntervals(my.data,n=nquantiles,style="quantile")
  my.pal.1<-findColours(my.class,c(upperleft,bottomleft))
  my.pal.2<-findColours(my.class,c(upperright, bottomright))
  col.matrix<-matrix(nrow = 101, ncol = 101, NA)
  for(i in 1:101){
    my.col<-c(paste(my.pal.1[i]),paste(my.pal.2[i]))
    col.matrix[102-i,]<-findColours(my.class,my.col)}
  if(.plot==T){
    plot(c(1,1),pch=19,col=my.pal.1, cex=cex, cex.axis=cex.axis, xlim=c(0,1),ylim=c(0,1),frame.plot=F, xlab=xlab, ylab=ylab,cex.lab=cex.lab,add=add)
    for(i in 1:101){
      col.temp<-col.matrix[i-1,]
      points(my.data,rep((i-1)/100,101),pch=15,col=col.temp, cex=cex)}}
  seqs<-seq(0,100,(100/nquantiles))
  seqs[1]<-1
  col.matrix <- col.matrix[c(seqs), c(seqs)]}

#### function to get equal binds from a vector
func_splint <- function(x,interval=4,dig.lab=5) {
  require(ggplot2)
  is.odd <- function(x) x %% 2 != 0
  
  a <- levels(cut_interval(x,interval-1,dig.lab=dig.lab))
  b <- unlist(strsplit(a,','))
  c <- gsub('[','',b,fixed="TRUE")
  d <- gsub(']','',c,fixed="TRUE")
  e <- gsub('(','',d,fixed="TRUE")
  f <- gsub(')','',e,fixed="TRUE")
  return(as.numeric(c(unique(f))))
}

# This function returns a dataframe with summary of sarmodels
# x = list of sar models from which summary will be returned
get.summary.models <- function(x){
  
  model.summary_ <- summary(x)
  model.summary_ <- model.summary_$Coef[-1,c(1,4)]
  
  model.confint <- data.frame(confint(x))
  model.confint <- model.confint[-which(grepl("Intercept",rownames(model.confint))),]
  if(length(which(grepl("lambda", rownames(model.confint))))>0){
    model.confint <- model.confint[-which(grepl("lambda",rownames(model.confint))),]
  }
  
  names(model.confint) <- c("Lower_IC","Higher_IC")
  
  model.summary_ <- cbind(model.summary_,model.confint)
  
  model.summary_$sig <- ifelse(model.summary_$`Pr(>|z|)`<0.05,1,0)
  model.summary_$var <- rownames(model.summary_)
  model.summary_$AIC <- AIC(x)
  
  rownames(model.summary_) <- NULL
  return(model.summary_)
}


```

# Coastal lines
```{r land, message=FALSE, warning=FALSE, include=FALSE}
land <- readOGR("D:/GIS/Shp files/WE_contour.shp")
crs(land) <-"+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 "

# project to equal area
land <- spTransform(land, CRS("+proj=moll +datum=WGS84"))

# crop shp
crop. <- getMap(resolution = "coarse")
crop. <- subset(crop., continent == "South America"|continent == "North America")
crs(crop.) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 "

# create a reference projection raster in a longlat projection and 0.5x0.5 degree resolution
reso <- 0.5
mod.r <- raster(xmn = -180, xmx = 180, ymn = -60, ymx = 90,
                crs = CRS("+proj=longlat +datum=WGS84"))
res(mod.r) <- reso
```

# Load  data
```{r loadData, message=FALSE, warning=FALSE}

dataset <- readRDS("Data/WorkData/dataset.RDS")

vars.ras <- dataset[,-which(names(dataset) %in%
                              c("biome","realm","forest","tropical"))]
vars.ras.names <- names(vars.ras)[-1:-2]

vars.ras <- pblapply(vars.ras.names, function(x) 
  rasterFromXYZ(data.frame(dataset[,1:2],dataset[,x])))
names(vars.ras) <- vars.ras.names
vars.ras <- stack(vars.ras)

```

# Maps
## Create rasters
```{r getJenksBreaks, warning=FALSE, include=FALSE}

class_int <- list()
for(j in 1:nlayers(vars.ras)){ cat("\r", j, "from", nlayers(vars.ras))
  # Get class intervals
  tmp <- na.omit(getValues(vars.ras[[j]]))
  if(is.numeric(tmp)){
    tmp[is.infinite(tmp)] <- NA
    class_int[[j]] <- 
      BAMMtools::getJenksBreaks(tmp, 20)
    # avoid identical breaks
    class_int[[j]] <- unique(class_int[[j]])
  }
  else{
    class_int[[j]] <- NA
  }
}
names(class_int) <- names(vars.ras)

```

## Sensitivity metrics
```{r Sensitivity, message=FALSE, warning=FALSE, fig.height=8, fig.width=7}

{
  # x11(width = 7, height = 4)
  
  par(mfrow=c(2,2), 
      mar=c(0,0,2,0))
  
  # Sensitivity precipitation cc
  labs <- c(0, .25, .5, .75, 1)
  plot(vars.ras$sens.temp, main = "Sensitivity to temperature\nClimate change", axes=F,box=F,
       breaks = class_int$sens.temp,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$sens.prec, 
       axis.args=list(at=labs, labels=labs), 
       breaks = class_int$sens.temp,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # Sensitivity temperature cc
  plot(vars.ras$sens.prec, main = "Sensitivity to precipitation\nClimate change", axes=F,box=F,
       breaks = class_int$sens.prec,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$sens.prec, 
       axis.args=list(at=labs, labels=labs), 
       breaks = class_int$sens.prec,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # Sensitivity precipitation sea
  plot(vars.ras$sens.temp, main = "Sensitivity to temperature\nSeasonality", axes=F,box=F,
       breaks = class_int$sens.temp,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$sens.prec, 
       axis.args=list(at=labs, labels=labs), 
       breaks = class_int$sens.temp,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # Sensitivity temperature sea
  plot(vars.ras$sens.prec, main = "Sensitivity to precipitation\nSeasonality", axes=F,box=F,
       breaks = class_int$sens.prec,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$sens.prec, 
       axis.args=list(at=labs, labels=labs), 
       breaks = class_int$sens.prec,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  
}

```

### Correlations
```{r cor_sens, message=FALSE, warning=FALSE, height=4, width=4}

my_data <- dataset[,c("sens.temp","sens.cc.temp","sens.sea.temp",
                      "sens.prec","sens.cc.prec","sens.sea.prec")]
chart.Correlation(my_data, histogram=TRUE, pch=19)

```

### Bivariate plot
```{r Bivariate, message=FALSE, warning=FALSE, fig.height=5, fig.width=5}
col.matrix <- colmat(nquantiles=10,
                     upperleft="#9874A2",
                     upperright="#FEF287",
                     bottomleft="snow",
                     bottomright="#21908D",
                     xlab="Sensitivity to precipitation",
                     ylab="Sensitivity to temperature",
                     .plot=F)

# Climate change 

bivmap <- bivariate.map(vars.ras$sens.cc.prec, vars.ras$sens.cc.temp,
                        colormatrix=col.matrix, nquantiles=5)

{
  par(mar=c(0,0,1,5))
  plot(bivmap, main = "Climate change",
       frame.plot=F, axes=F, box=F, legend=F, 
       col=as.vector(col.matrix))
  plot(land, add=T, cex = .6)
  
  par(mex = .5, plt = c(0.65, 0.95, 0.2, 0.5), new = TRUE)
  colmat(nquantiles=5, 
         upperleft="#9874A2", 
         upperright="#FEF287", 
         bottomleft="snow", 
         bottomright="#21908D",
         xlab="Sensitivity to precipitation", 
         ylab="Sensitivity to temperature",
         cex.lab = .8, cex.axis=.6,
         .plot=T, add=T)
}


# Seasonality

bivmap <- bivariate.map(vars.ras$sens.sea.prec, vars.ras$sens.sea.temp,
                        colormatrix=col.matrix, nquantiles=5)

{
  par(mar=c(0,0,1,5))
  plot(bivmap, main = "Seasonality",
       frame.plot=F, axes=F, box=F, legend=F, 
       col=as.vector(col.matrix))
  plot(land, add=T, cex = .6)
  
  par(mex = .5, plt = c(0.65, 0.95, 0.2, 0.5), new = TRUE)
  colmat(nquantiles=5, 
         upperleft="#9874A2", 
         upperright="#FEF287", 
         bottomleft="snow", 
         bottomright="#21908D",
         xlab="Sensitivity to precipitation", 
         ylab="Sensitivity to temperature",
         cex.lab = .8, cex.axis=.6,
         .plot=T, add=T)
}


```


## Biodiversity metrics
### Richness metrics
```{r bio.metrics.rich, message=FALSE, warning=FALSE, fig.height=4, fig.width=10.5}

{
  # x11(width = 10.5, height = 4)
  
  par(mfrow=c(1,3), 
      mar=c(0,0,2,0))
  
  # Richness
  labs <- round(func_splint(class_int$rich,5),3)
  plot(vars.ras$rich, main = "Richness", axes=F,box=F,
       breaks = class_int$rich,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$rich, 
       axis.args=list(at=labs, labels=round(labs,0)), 
       breaks = class_int$rich,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # PD
  labs <- round(func_splint(class_int$PD,5),3)
  plot(vars.ras$PD, main = "Phylogenetic diversity (PD)", axes=F,box=F,
       legend = F,
       breaks = class_int$PD,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$PD, 
       axis.args=list(at=labs, labels=round(labs,0)), 
       breaks = class_int$PD,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # FD
  labs <- round(func_splint(class_int$FRich,5),3)
  plot(vars.ras$FRich, main = "Functional richness (FRich)", axes=F,box=F,
       breaks = class_int$FRich,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$FRich, 
       axis.args=list(at=labs, labels=round(labs,2)), 
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
}


```

### Dispersion metrics
```{r bio.metrics.disp, message=FALSE, warning=FALSE, fig.height=4, fig.width=10.5}

{
  # x11(width = 10.5, height = 4)
  
  par(mfrow=c(1,3), 
      mar=c(0,0,2,0))
  
  # Richness
  labs <- round(func_splint(class_int$rich,5),3)
  plot(vars.ras$rich, main = "Richness", axes=F,box=F,
       breaks = class_int$rich,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$rich, 
       axis.args=list(at=labs, labels=round(labs,0)), 
       breaks = class_int$rich,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # PD
  labs <- round(func_splint(class_int$MPD,5),3)
  plot(vars.ras$MPD, main = "Mean phylogenetic distance (MPD)", axes=F,box=F,
       legend = F,
       breaks = class_int$MPD,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$MPD, 
       axis.args=list(at=labs, labels=round(labs,0)), 
       breaks = class_int$MPD,
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
  
  # FD
  labs <- round(func_splint(class_int$FDis,5),3)
  plot(vars.ras$FDis, main = "Functional dispersion (FDis)", axes=F,box=F,
       breaks = class_int$FDis,
       legend = F,
       col=rev(viridis(30)))
  # legend
  plot(vars.ras$FDis, 
       axis.args=list(at=labs, labels=round(labs,2)), 
       legend.only = T,
       col=rev(viridis(30)),
       smallplot=c(0.8,0.82, 0.02,0.3))
  plot(land, add=T, cex = .6)
}

```

### Correlations rich metrics
```{r cor_bio, message=FALSE, warning=FALSE, height=4, width=4}

my_data <- dataset[,c("rich","PD","FRich", "MPD", "FDis")]
chart.Correlation(my_data, histogram=TRUE, pch=19)

```

# Sens ~ Biodiv

```{r 3D, eval=FALSE, message=FALSE, warning=FALSE, height=4, width=4}

library("plot3D")

nums <- sample(1:nrow(datarun),100)
# x, y, z variables
x <- datarun$FDis[nums]
y <- datarun$pdsi[nums]
z <- datarun$sens.temp[nums]
# Compute the linear regression (z = ax + by + d)
fit <- lm(z ~ x + y)
# predict values on regular xy grid
grid.lines = 26
x.pred <- seq(min(x), max(x), length.out = grid.lines)
y.pred <- seq(min(y), max(y), length.out = grid.lines)
xy <- expand.grid( x = x.pred, y = y.pred)
z.pred <- matrix(predict(fit, newdata = xy), 
                 nrow = grid.lines, ncol = grid.lines)
# fitted points for droplines to surface
fitpoints <- predict(fit)
# scatter plot with regression plane
scatter3D(x, y, z, pch = 18, cex = 2, 
    theta = 20, phi = 20, ticktype = "detailed",
    xlab = "rich", ylab = "temp_sea", zlab = "sens",  
    surf = list(x = x.pred, y = y.pred, z = z.pred,  
    facets = NA, fit = fitpoints))

################
library(plotly)
library(reshape2)

my_lem <- lm(sens.temp ~ FDis + pdsi,data = datarun[nums,])

#Graph Resolution (more important for more complex shapes)
graph_reso <- 0.05

#Setup Axis
axis_x <- seq(min(datarun[nums,]$FDis), max(datarun[nums,]$FDis), by = graph_reso)
axis_y <- seq(min(datarun[nums,]$pdsi), max(datarun[nums,]$pdsi), by = graph_reso)

#Sample points
my_lem_surface <- expand.grid(FDis = axis_x,pdsi = axis_y,KEEP.OUT.ATTRS = F)
my_lem_surface$sens.temp <- predict.lm(my_lem, newdata = my_lem_surface)
my_lem_surface <- acast(my_lem_surface, pdsi ~ FDis, value.var = "sens.temp") #y ~ x

hcolors=heat.colors(n=100)
iris_plot <- plot_ly(datarun[nums,], 
                     x = ~FDis, 
                     y = ~pdsi, 
                     z = ~sens.temp,
                     text = ~sens.temp, # EDIT: ~ added
                     type = "scatter3d", 
                     mode = "markers",
                     marker = list(color = hcolors))

iris_plot <- add_trace(p = iris_plot,
                       z = my_lem_surface,
                       x = axis_x,
                       y = axis_y,
                       type = "surface")

iris_plot

#####################

plot_ly(x=x, y=y, z=z,
        type = "surface") %>%
   layout(scene = list(dragmode="turntable"))

ggplot(diamonds) +
  stat_density_2d(aes(x = x, y = y, fill = z), n = 100, bins = 10, contour = TRUE) +
  scale_fill_viridis_c(option = "A")


ggplot(datarun)+
  stat_density_2d(aes(x = rich, y = sens.temp, fill = temp_sea),
                  geom = "raster", contour = FALSE) +
  scale_fill_viridis_c(option = "A")
  
```

## Temperature (climate change)
```{r sens_biotemp_cc, message=FALSE, warning=FALSE, fig.height=3, fig.width=9}

p1 <- ggplot(dataset, aes(x = rich, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = PD, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("PD")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p3 <- ggplot(dataset, aes(x = FRich, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FRich")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra


p1 <- ggplot(dataset, aes(x = rich, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = MPD, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("MPD")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p3 <- ggplot(dataset, aes(x = FDis, y = sens.cc.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FDis")+
  ylab("Sensitivity to temperature")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

```

## Temperature (seasonality)
```{r sens_biotemp_sea, message=FALSE, warning=FALSE, fig.height=3, fig.width=9}

p1 <- ggplot(dataset, aes(x = rich, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = PD, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("PD")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p3 <- ggplot(dataset, aes(x = FRich, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FRich")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

p1 <- ggplot(dataset, aes(x = rich, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = MPD, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("MPD")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1) + ylim(c(0,1))

p3 <- ggplot(dataset, aes(x = FDis, y = sens.sea.temp))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FDis")+
  ylab("Sensitivity to temperature")+
  # geom_smooth(method = "lm", size = 2,se = F,
  #             aes(color = biome)) +
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

```



## Precipitation (climate change)
```{r sens_bioprec_cc, message=FALSE, warning=FALSE, fig.height=3, fig.width=9}

p1 <- ggplot(dataset, aes(x = rich, y = sens.cc.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = PD, y = sens.cc.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("PD")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p3 <- ggplot(dataset, aes(x = FRich, y = sens.cc.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FRich")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

p1 <- ggplot(dataset, aes(x = rich, y = sens.cc.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("Richness")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = MPD, y = sens.cc.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("MPD")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1) + ylim(c(0,1))

p3 <- ggplot(dataset, aes(x = FDis, y = sens.cc.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("FDis")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

```

## Precipitation (seasonality)
```{r sens_bioprec_sea, message=FALSE, warning=FALSE, fig.height=3, fig.width=9}

p1 <- ggplot(dataset, aes(x = rich, y = sens.sea.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("Richness")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = PD, y = sens.sea.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("PD")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p3 <- ggplot(dataset, aes(x = FRich, y = sens.sea.prec))+
  theme_bw()+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  xlab("FRich")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra

p1 <- ggplot(dataset, aes(x = rich, y = sens.sea.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("Richness")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

p2 <- ggplot(dataset, aes(x = log(MPD), y = sens.sea.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("MPD")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1) + ylim(c(0,1))

p3 <- ggplot(dataset, aes(x = FDis, y = sens.sea.prec))+
  geom_hex()+
  scale_fill_gradient(low="lightblue1",high="darkblue",trans="log10") +
  theme_bw()+
  xlab("FDis")+
  ylab("Sensitivity to precipitation")+
  geom_smooth(method = "lm", size = 2, color = "black") +
  guides(colour = guide_legend(override.aes = list(alpha = 1,size=3)))+
  theme(aspect.ratio=1)

grid.arrange(p1 + theme(legend.position="none"),
             p2 + theme(legend.position="none"),
             p3 + theme(legend.position="none"),
             nrow = 1) #use package gridExtra


```

# SAR models
We spatial autoregressive models using each of the three sensitivity metric (Aridity, Precipitation and Temperature) as response variable, and the three biodiversity metric as predictors (species richness, phylogenetic diversity and functional diversity). 

```{r prep.sar, warning=F, message=F}
datarun <- na.omit(dataset[,c("x","y",
                              "pdsi", "temp_sea", "velocity", "clim.stab", "temp.stab",
                              "sens.cc.temp", "sens.cc.temp.confint",
                              "sens.cc.prec", "sens.cc.prec.confint",
                              "sens.sea.temp", "sens.sea.temp.confint",
                              "sens.sea.prec", "sens.sea.prec.confint",
                              "rich","PD","FRich","MPD","FDis")])
datarun$sens.cc.temp <- log(datarun$sens.cc.temp)
datarun$sens.cc.prec <- log(datarun$sens.cc.prec)
datarun$sens.sea.temp <- log(datarun$sens.sea.temp)
datarun$sens.sea.prec <- log(datarun$sens.sea.prec)

# test
# plot(rasterFromXYZ(datarun[,1:3]))

# Scale?
# I ran models without scaling and got the error:
# Error in solve.default(-(mat), tol.solve = tol.solve) : 
# system is computationally singular: reciprocal condition number
datarun[,c("pdsi", "temp_sea", "velocity", "clim.stab", "temp.stab",
           "sens.cc.temp", 
           "sens.cc.prec", 
           "sens.sea.temp",
           "sens.sea.prec", 
           "rich","PD","FRich","MPD","FDis")] <- 
  scale(datarun[,c("pdsi", "temp_sea", "velocity", "clim.stab", "temp.stab",
                   "sens.cc.temp", 
                   "sens.cc.prec", 
                   "sens.sea.temp",
                   "sens.sea.prec", 
                   "rich","PD","FRich","MPD","FDis")])

# define connectivity matrix (0/1)
nbdist<-dnearneigh(x=as.matrix(datarun[,1:2]), d1=0, d2=50000) 
# compute the Euclidean distance between neighbouring sites
neigh.dist<-nbdists(nbdist,
                    as.matrix(datarun[,1:2]), longlat=F)
# compute the inverse distance weigthed matrix
inverse<-lapply(neigh.dist, function(x) (1/(x^2)))
# coding style W = row standardised
nlw <- nb2listw(neighbours=nbdist, 
                glist=inverse,
                style="W", 
                zero.policy=T) 

models2goDisp <- c(
  # Dispersion metrics
  'sens.cc.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*velocity + MPD*velocity + FDis*velocity',
  'sens.cc.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*clim.stab + MPD*clim.stab + FDis*clim.stab',
  'sens.cc.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*temp.stab + MPD*temp.stab + FDis*temp.stab',
  
  'sens.cc.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*velocity + MPD*velocity + FDis*velocity',
  'sens.cc.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*clim.stab + MPD*clim.stab + FDis*clim.stab',
  'sens.cc.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*temp.stab + MPD*temp.stab + FDis*temp.stab',
  
  'sens.sea.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*velocity + MPD*velocity + FDis*velocity',
  'sens.sea.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*clim.stab + MPD*clim.stab + FDis*clim.stab',
  'sens.sea.temp ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*temp.stab + MPD*temp.stab + FDis*temp.stab',
  
  'sens.sea.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*velocity + MPD*velocity + FDis*velocity',
  'sens.sea.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*clim.stab + MPD*clim.stab + FDis*clim.stab',
  'sens.sea.prec ~ rich*pdsi + MPD*pdsi + FDis*pdsi + rich*temp_sea + MPD*temp_sea + FDis*temp_sea + rich*temp.stab + MPD*temp.stab + FDis*temp.stab'
)

models2goRich <- c(
  # Richness metrics
  'sens.cc.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*velocity + PD*velocity + FRich*velocity',
  'sens.cc.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*clim.stab + PD*clim.stab + FRich*clim.stab',
  'sens.cc.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*temp.stab + PD*temp.stab + FRich*temp.stab',
  
  'sens.cc.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*velocity + PD*velocity + FRich*velocity',
  'sens.cc.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*clim.stab + PD*clim.stab + FRich*clim.stab',
  'sens.cc.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*temp.stab + PD*temp.stab + FRich*temp.stab',
  
  'sens.sea.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*velocity + PD*velocity + FRich*velocity',
  'sens.sea.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*clim.stab + PD*clim.stab + FRich*clim.stab',
  'sens.sea.temp ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*temp.stab + PD*temp.stab + FRich*temp.stab',
  
  'sens.sea.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*velocity + PD*velocity + FRich*velocity',
  'sens.sea.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*clim.stab + PD*clim.stab + FRich*clim.stab',
  'sens.sea.prec ~ rich*pdsi + PD*pdsi + FRich*pdsi + rich*temp_sea + PD*temp_sea + FRich*temp_sea + rich*temp.stab + PD*temp.stab + FRich*temp.stab'
)


# Weight paramenters
weightpar <- c(rep("sens.cc.temp.confint",3),
               rep("sens.cc.prec.confint",3),
               rep("sens.sea.temp.confint",3),
               rep("sens.sea.prec.confint",3))
```

## Send data to the cluster
```{r SAR.models.save2cluster, message=FALSE, warning=FALSE, eval=F}
# Save and send to the cluster
# Models run the computer cluster
saveRDS(datarun, "R/Cluster/SARmodels/datarun.RDS")
saveRDS(models2goDisp, "R/Cluster/SARmodels/models2goDisp.RDS")
saveRDS(models2goRich, "R/Cluster/SARmodels/models2goRich.RDS")
saveRDS(weightpar, "R/Cluster/SARmodels/weightpar.RDS")
saveRDS(nlw, "R/Cluster/SARmodels/nlw.RDS")

```

## Models using dispersion metrics
```{r my.models.disp, message=FALSE, warning=FALSE}
DT::datatable(data.frame(models=models2goDisp))
```

## Models using richness metrics
```{r my.models.tab.rich, message=FALSE, warning=FALSE}
DT::datatable(data.frame(models=models2goRich))
```

## Check VIF models
```{r my.models, eval=FALSE, message=FALSE, warning=FALSE}

# VIF var models
lms <- lapply(1:length(models2goRich), 
              function(i) 
                lm(models2goRich[i], data = datarun, 
                   weights = datarun[,weightpar[i]]))

vifs_lms <- lapply(lms, function(i) car::vif(i))
vifs_lms <- do.call(rbind,vifs_lms)

vifs_lms

lms <- lapply(1:length(models2goDisp), 
              function(i) 
                lm(models2goDisp[i], data = datarun, 
                   weights = datarun[,weightpar[i]]))

vifs_lms <- lapply(lms, function(i) car::vif(i))
vifs_lms <- do.call(rbind,vifs_lms)

vifs_lms

# VIF vars
HH::vif(x=datarun[,-1:-2])

```

Both PD and FD variables share high VIF (>10), suggesting extreme multicollinarity.


## Load results from SAR models
```{r SAR.models.load, message=FALSE, warning=FALSE, include=FALSE}

SAR.res.Disp <- list()
for(i in 1:length(models2goDisp)){ cat("\r",i,"from",length(SAR.res.Disp))
  modeli <- readRDS(paste("R/Cluster/SARmodels/Results/MD", i,".RDS",sep=""))
  modeli <- get.summary.models(modeli)
  modeli$model <- models2goDisp[i]
  modeli$Response <- strsplit(models2goDisp[i],split = " ~ ")[[1]][1]
  modeli$Mi <- paste("M",i,sep = "")
  SAR.res.Disp[[i]] <- modeli
}

SAR.res.Disp <- do.call(rbind,SAR.res.Disp)

SAR.res.Rich <- list()
for(i in 1:length(models2goRich)){ cat("\r",i,"from",length(SAR.res.Rich))
  modeli <- readRDS(paste("R/Cluster/SARmodels/Results/MR", i,".RDS",sep=""))
  modeli <- get.summary.models(modeli)
  modeli$model <- models2goRich[i]
  modeli$Response <- strsplit(models2goRich[i],split = " ~ ")[[1]][1]
  modeli$Mi <- paste("M",i,sep = "")
  SAR.res.Rich[[i]] <- modeli
}

SAR.res.Rich <- do.call(rbind,SAR.res.Rich)

```

## Plot SAR results
### Dispersion metrics
#### Option 1
```{r SAR.models.res.dis1, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
# For clim.stab models
SAR.res.Disp.plot <- SAR.res.Disp[grep("clim.stab",SAR.res.Disp$model),]
SAR.res.Disp.plot$sig <- ifelse(SAR.res.Disp.plot$`Pr(>|z|)` < 0.05, "<0.05", "NS")
SAR.res.Disp.plot$sig <- factor(SAR.res.Disp.plot$sig, levels = c( "NS","<0.05"))

SAR.res.Disp.plot$Response <- gsub("sens.temp","Sens. Temp.", SAR.res.Disp.plot$Response)
SAR.res.Disp.plot$Response <- gsub("sens.prec","Sens. Prec.", SAR.res.Disp.plot$Response)
SAR.res.Disp.plot$Response <- gsub("sens.cc.temp","Sens. Temp. CC.", SAR.res.Disp.plot$Response)
SAR.res.Disp.plot$Response <- gsub("sens.cc.prec","Sens. Prec. CC.", SAR.res.Disp.plot$Response)
SAR.res.Disp.plot$Response <- gsub("sens.sea.temp","Sens. Temp. Sea.", SAR.res.Disp.plot$Response)
SAR.res.Disp.plot$Response <- gsub("sens.sea.prec","Sens. Prec. Sea.", SAR.res.Disp.plot$Response)

SAR.res.Disp.plot$Response<-factor(SAR.res.Disp.plot$Response, levels=c("Sens. Temp.","Sens. Temp. CC.","Sens. Temp. Sea.","Sens. Prec.","Sens. Prec. CC.","Sens. Prec. Sea."))

SAR.res.Disp.plot$var.name <- NA
SAR.res.Disp.plot$var.name <- gsub("rich","Rich", SAR.res.Disp.plot$var)
SAR.res.Disp.plot$var.name <- gsub("MPD","MPD", SAR.res.Disp.plot$var.name)
SAR.res.Disp.plot$var.name <- gsub("pdsi","Aridity", SAR.res.Disp.plot$var.name)
SAR.res.Disp.plot$var.name <- gsub("temp_sea","Seasonality", SAR.res.Disp.plot$var.name)
SAR.res.Disp.plot$var.name <- gsub("clim.stab","Stability", SAR.res.Disp.plot$var.name)

SAR.res.Disp.plot$var.type <- SAR.res.Disp.plot$var
SAR.res.Disp.plot$var.type <- gsub("rich","Biodiversity", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("MPD","Biodiversity", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("FDis","Biodiversity", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("pdsi","Climate", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("temp_sea","Climate", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("clim.stab","Climate", SAR.res.Disp.plot$var.type)
SAR.res.Disp.plot$var.type <- gsub("Climate:Biodiversity","Biodiversity:Climate", SAR.res.Disp.plot$var.type)

SAR.res.Disp.plot$var.name<-factor(SAR.res.Disp.plot$var.name, levels=rev(c("Rich","MPD","FDis","Aridity","Seasonality","Stability","Rich:Aridity","Aridity:MPD","Aridity:FDis","Rich:Seasonality","MPD:Seasonality","FDis:Seasonality","Rich:Stability","MPD:Stability","FDis:Stability")))

# Do not plot interactions
SAR.res.Disp.plot <- SAR.res.Disp.plot[-grep(":",SAR.res.Disp.plot$var),]

pd <- position_dodge(0.5)

ggplot(SAR.res.Disp.plot, aes(x = var.name, y = Estimate, 
                              alpha = sig, color = var.type)) +
  scale_alpha_discrete(c(.5,1), guide = F)+
  geom_linerange(aes(ymin=Lower_IC, ymax=Higher_IC), position = pd, size = 1) +
  geom_point(position=pd, size = 3) +
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  theme_bw()+
  coord_flip()+
  labs(color = 'Predictor type', y="Std. Coeff. + CI", x= '')+
  theme(axis.text.x = element_text(angle = 45,  hjust = 1))+
  theme(legend.position="bottom")+
  facet_wrap(Response~.,ncol = 2)
  

```

#### Option 2
```{r SAR.models.res.dis2, fig.height=3, fig.width=5, message=FALSE, warning=FALSE}

ggplot(SAR.res.Disp.plot, aes(Response, var.name,
                         label=round(Estimate, 2), 
                         fill=Estimate)) +
  geom_tile(alpha=0.9)+
  scale_fill_gradient2(low = "red", 
                       mid = "white", 
                       high = "midnightblue", 
                       midpoint = 0) + # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Std. Coeff.")

```
  
### Richness metrics
#### Option 1
```{r SAR.models.res.rich1, fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
# For clim.stab models
SAR.res.Rich.plot <- SAR.res.Rich[grep("clim.stab",SAR.res.Rich$model),]
SAR.res.Rich.plot$sig <- ifelse(SAR.res.Rich.plot$`Pr(>|z|)` < 0.05, "<0.05", "NS")
SAR.res.Rich.plot$sig <- factor(SAR.res.Rich.plot$sig, levels = c( "NS","<0.05"))

SAR.res.Rich.plot$Response <- gsub("sens.temp","Sens. Temp.", SAR.res.Rich.plot$Response)
SAR.res.Rich.plot$Response <- gsub("sens.prec","Sens. Prec.", SAR.res.Rich.plot$Response)
SAR.res.Rich.plot$Response <- gsub("sens.cc.temp","Sens. Temp. CC.", SAR.res.Rich.plot$Response)
SAR.res.Rich.plot$Response <- gsub("sens.cc.prec","Sens. Prec. CC.", SAR.res.Rich.plot$Response)
SAR.res.Rich.plot$Response <- gsub("sens.sea.temp","Sens. Temp. Sea.", SAR.res.Rich.plot$Response)
SAR.res.Rich.plot$Response <- gsub("sens.sea.prec","Sens. Prec. Sea.", SAR.res.Rich.plot$Response)

SAR.res.Rich.plot$Response<-factor(SAR.res.Rich.plot$Response, levels=c("Sens. Temp.","Sens. Temp. CC.","Sens. Temp. Sea.","Sens. Prec.","Sens. Prec. CC.","Sens. Prec. Sea."))

SAR.res.Rich.plot$var.name <- NA
SAR.res.Rich.plot$var.name <- gsub("rich","Rich", SAR.res.Rich.plot$var)
SAR.res.Rich.plot$var.name <- gsub("PD","PD", SAR.res.Rich.plot$var.name)
SAR.res.Rich.plot$var.name <- gsub("FRich","FRich", SAR.res.Rich.plot$var.name)
SAR.res.Rich.plot$var.name <- gsub("pdsi","Aridity", SAR.res.Rich.plot$var.name)
SAR.res.Rich.plot$var.name <- gsub("temp_sea","Seasonality", SAR.res.Rich.plot$var.name)
SAR.res.Rich.plot$var.name <- gsub("clim.stab","Stability", SAR.res.Rich.plot$var.name)

SAR.res.Rich.plot$var.type <- SAR.res.Rich.plot$var
SAR.res.Rich.plot$var.type <- gsub("rich","Biodiversity", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("PD","Biodiversity", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("FRich","Biodiversity", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("pdsi","Climate", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("temp_sea","Climate", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("clim.stab","Climate", SAR.res.Rich.plot$var.type)
SAR.res.Rich.plot$var.type <- gsub("Climate:Biodiversity","Biodiversity:Climate", SAR.res.Rich.plot$var.type)

SAR.res.Rich.plot$var.name<-factor(SAR.res.Rich.plot$var.name,
                         levels=rev(c("Rich","PD","FRich","Aridity","Seasonality","Stability","Rich:Aridity","Aridity:PD","Aridity:FRich","Rich:Seasonality","PD:Seasonality","FRich:Seasonality","Rich:Stability","PD:Stability","FRich:Stability")))

# Do not plot interactions
SAR.res.Rich.plot <- SAR.res.Rich.plot[-grep(":",SAR.res.Rich.plot$var),]

pd <- position_dodge(0.5)

ggplot(SAR.res.Rich.plot, aes(x = var.name, y = Estimate, 
                              alpha = sig, color = var.type))+
  scale_alpha_discrete(c(.5,1), guide = F)+
  geom_linerange(aes(ymin=Lower_IC, ymax=Higher_IC), position = pd, size = 1) +
  geom_point(position=pd, size = 3) +
  geom_hline(yintercept=0, linetype="dashed", color = "black")+
  theme_bw()+
  coord_flip()+
  labs(color = 'Predictor type', y="Std. Coeff. + CI", x= '') +
  theme(axis.text.x = element_text(angle = 45,  hjust = 1)) +
  theme(legend.position="bottom") +
  facet_wrap(Response~., ncol = 2)
  

```

#### Option 2
```{r SAR.models.res.rich2, fig.height=3, fig.width=5, message=FALSE, warning=FALSE}

ggplot(SAR.res.Rich.plot, aes(Response, var.name,
                         label=round(Estimate, 2), 
                         fill=Estimate)) +
  geom_tile(alpha=0.9)+
  scale_fill_gradient2(low = "red", 
                       mid = "white", 
                       high = "midnightblue", 
                       midpoint = 0) + # determine the colour
  theme(panel.grid.major.x=element_blank(), #no gridlines
        panel.grid.minor.x=element_blank(),
        panel.background=element_rect(fill="white"), # background=white
        axis.text.x = element_text(angle=45, hjust = 1,vjust=1)) + 
  scale_x_discrete(name="") +
  scale_y_discrete(name="") +
  labs(fill="Std. Coeff.")

```

## Predict SAR models
### Richness metrics
```{r SAR.models.proj.rich, message=FALSE, warning=FALSE}
# For clim.stab models
models2go.proj <- grep("clim.stab", models2goRich)
models2go.proj.names <- models2goRich[models2go.proj]

predictors <- c("rich","PD","FRich")

# Projections results

preds <- list()

for(m in 1:length(models2go.proj)){ # For each model == sensitivity metric
  # load model
  modeli <- readRDS(paste("R/Cluster/SARmodels/Results/MR",
                          models2go.proj[m],".RDS",sep=""))
  
  y <- strsplit(models2go.proj.names[m],split = " ~ ")[[1]][1]
  
  pred.vars <- list()
  for(p in 1:length(predictors)){ # for each predictor variable
    # create 10 bins for projection
    bins <- func_splint(datarun[,predictors[p]], interval = 10)
    
    pred.bin <- list()
    for(i in 1:10){ # project for each of the 10 bins
      datarun.tmp <- datarun
      datarun.tmp[,predictors[p]] <- bins[i]
      # predict
      pred.i.tmp <- spatialreg::predict.sarlm(modeli, 
                                              newdata = datarun.tmp,
                                              zero.policy=TRUE)
      pred.bin[[i]] <- data.frame(binID=i, bin = bins[i], pred.i.tmp, 
                                  predictor = predictors[p], 
                                  datarun[,c("pdsi", "temp_sea", "clim.stab",y)],
                                  model = y)
    }
    pred.bin <- do.call(rbind,pred.bin)
    pred.vars[[p]] <- pred.bin
  }
  names(pred.vars) <- predictors
  preds[[m]] <- pred.vars
}
names(preds) <- unlist(lapply(models2go.proj.names, 
                              function(x) strsplit(x,split = " ~ ")[[1]][1]))

preds.tmp <- lapply(preds, function(x) do.call(rbind,x))

# Fix var names
preds.tmp.plot <- lapply(preds.tmp, function(x) {
  x <- reshape::melt(x, measure.vars = c("pdsi", "temp_sea", "clim.stab"))
  
  x$predictor <- gsub("rich","Richness", x$predictor)
  x$predictor <- factor(x$predictor,
                        levels = c("Richness", "PD", "FRich"))
  
  x$variable <- gsub("pdsi","Aridity", x$variable)
  x$variable <- gsub("temp_sea","Seasonality", x$variable)
  x$variable <- gsub("clim.stab","Climate stability", x$variable)
  x$variable <- factor(x$variable,
                       levels = c("Aridity", "Seasonality", "Climate stability"))
  x
}
)
names(preds.tmp.plot) <- names(preds.tmp)

```

#### Plot SAR results

##### Sensitivity to temperature (climate change)
```{r proj.sens.cc.temp.dis, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.cc.temp, 
       aes(x = value, y = sens.cc.temp, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to temperature (Climate change)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free_x")

```

##### Sensitivity to temperature (seasonality)
```{r proj.sens.sea.temp.dis, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.sea.temp, 
       aes(x = value, y = sens.sea.temp, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to temperature (Seasonality)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free")


```

##### Sensitivity to precipitation (climate change)
```{r proj.sens.cc.prec.dis, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.cc.prec, 
       aes(x = value, y = sens.cc.prec, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to precipitation (Climate change)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free")

```




##### Sensitivity to precipitation (seasonality)
```{r proj.sens.sea.prec.dis, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}


ggplot(data = preds.tmp.plot$sens.sea.prec, 
       aes(x = value, y = sens.sea.prec, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to precipitation (Seasonality)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free")


```


### Dispersion metrics
```{r SAR.models.proj.dis, message=FALSE, warning=FALSE}
# For clim.stab models
models2go.proj <- grep("clim.stab",models2goDisp)
models2go.proj.names <- models2goDisp[models2go.proj]

predictors <- c("rich","MPD","FDis")

# Projections results

preds <- list()

for(m in 1:length(models2go.proj)){ # For each model == sensitivity metric
  # load model
  modeli <- readRDS(paste("R/Cluster/SARmodels/Results/MD",
                          models2go.proj[m],".RDS",sep=""))
  
  y <- strsplit(models2go.proj.names[m],split = " ~ ")[[1]][1]
  
  pred.vars <- list()
  for(p in 1:length(predictors)){ # for each predictor variable
    # create 10 bins for projection
    bins <- func_splint(datarun[,predictors[p]], interval = 10)
    
    pred.bin <- list()
    for(i in 1:10){ # project for each of the 10 bins
      datarun.tmp <- datarun
      datarun.tmp[,predictors[p]] <- bins[i]
      # predict
      pred.i.tmp <- spatialreg::predict.sarlm(modeli, 
                                              newdata = datarun.tmp,
                                              zero.policy=TRUE)
      pred.bin[[i]] <- data.frame(binID=i, bin = bins[i], pred.i.tmp, 
                                  predictor = predictors[p], 
                                  datarun[,c("pdsi", "temp_sea", "clim.stab",y)],
                                  model = y)
    }
    pred.bin <- do.call(rbind,pred.bin)
    pred.vars[[p]] <- pred.bin
  }
  names(pred.vars) <- predictors
  preds[[m]] <- pred.vars
}
names(preds) <- unlist(lapply(models2go.proj.names, 
                              function(x) strsplit(x,split = " ~ ")[[1]][1]))

preds.tmp <- lapply(preds, function(x) do.call(rbind,x))

# Fix var names
preds.tmp.plot <- lapply(preds.tmp, function(x) {
  x <- reshape::melt(x, measure.vars = c("pdsi", "temp_sea", "clim.stab"))
  
  x$predictor <- gsub("rich","Richness", x$predictor)
  x$predictor <- factor(x$predictor,
                        levels = c("Richness", "MPD", "FDis"))
  
  x$variable <- gsub("pdsi","Aridity", x$variable)
  x$variable <- gsub("temp_sea","Seasonality", x$variable)
  x$variable <- gsub("clim.stab","Climate stability", x$variable)
  x$variable <- factor(x$variable,
                       levels = c("Aridity", "Seasonality", "Climate stability"))
  x
}
)
names(preds.tmp.plot) <- names(preds.tmp)

```

#### Plot SAR results

##### Sensitivity to temperature (climate change)
```{r proj.sens.cc.temp.rich, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.cc.temp, 
       aes(x = value, y = sens.cc.temp, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to temperature (Climate change)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free_x")

```

##### Sensitivity to temperature (seasonality)
```{r proj.sens.sea.temp.rich, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.sea.temp, 
       aes(x = value, y = sens.sea.temp, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to temperature (Seasonality)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free_x")


```

##### Sensitivity to precipitation (climate change)
```{r proj.sens.cc.prec.rich, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}

ggplot(data = preds.tmp.plot$sens.cc.prec, 
       aes(x = value, y = sens.cc.prec, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to precipitation (Climate change)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free_x")

```


##### Sensitivity to precipitation (seasonality)
```{r proj.sens.sea.prec.rich, message=FALSE, warning=FALSE, fig.height=5, fig.width=7}


ggplot(data = preds.tmp.plot$sens.sea.prec, 
       aes(x = value, y = sens.sea.prec, 
           color = as.factor(binID))) +
  scale_color_manual(values=myramp, name="Biodiversity level") + 
  geom_smooth(aes(y = fit), method = "lm", se = F, size = 1)+
  xlab("Climate metric")+
  ylab("Sensitivity to precipitation (Seasonality)")+
  scale_radius()+theme_bw()+
  facet_grid(predictor~variable, scales = "free_x")


```

# Save
```{r save, eval=FALSE, message=FALSE, warning=FALSE}
save.image("R/4_Analyses.RData")
```